<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Search & Browse - Media App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="Resources/styles.css">
    <style>
        /* Base styles from original request */
        #iframe-container {
            width: 100%; /* Changed from vh to % */
            height: calc(100vh - 60px); /* Adjust height as needed, considering other elements */
            display: flex;
            flex-direction: column;
        }
        #series-info-iframe {
            flex-grow: 1;
            border: none;
        }
        .back-button {
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
        }
        .back-button i {
            margin-right: 8px;
        }
        .search-bar-container input {
            flex-grow: 1;
        }
        .search-bar-container .fa-search {
            cursor: pointer;
        }
        .recent-search-item {
            background-color: #4A4A4F;
            color: #eee;
            padding: 10px 15px;
            border-radius: 20px;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            font-size: 0.9em;
            cursor: pointer;
        }
        .recent-search-item span {
            margin-right: 10px;
        }
        .recent-search-item .fa-times {
            cursor: pointer;
            color: #aaa;
        }
        .recent-search-item .fa-times:hover {
            color: #fff;
        }
        .item-list#search-item-list.recent-searches-active {
            display: flex;
            flex-wrap: wrap;
            padding-left: 0;
        }
        .list-item.card-style {
            display: flex;
            align-items: center;
            background-color: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .list-item.card-style:hover {
            background-color: #3a3a3a;
        }
        .list-item.card-style .item-thumbnail img {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }
        .list-item.card-style .item-details {
            flex-grow: 1;
        }
        .list-item.card-style .item-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .list-item.card-style .item-meta {
            margin-bottom: 5px;
        }
        .list-item.card-style .meta-pill {
            background-color: #444;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .list-item.card-style .item-description {
            font-size: 0.9em;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .list-item.card-style .item-arrow {
            margin-left: 10px;
            color: #888;
        }
        .pagination-container {
            margin-top: 25px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 18px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: var(--accent-color-active);
        }
        .pagination-btn:disabled {
            background-color: #202020;
            color: #555;
            cursor: not-allowed;
        }
        .pagination-container span {
            color: #aaa;
            font-size: 0.9em;
        }
        .search-options-list {
            display: flex;
            gap: 18px;
            margin: 18px 0 10px 0;
            padding: 0 2px;
            list-style: none;
        }
        .search-option-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1em;
            font-weight: 500;
            padding: 7px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
        }
        .search-option-btn.active {
            background: var(--accent-color-active, #e50914);
            color: #fff;
        }

        /* --- New styles for Browse Tab --- */
        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0 20px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #555 #222;
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .horizontal-scroll-container::-webkit-scrollbar-track {
            background: #222;
        }
        .horizontal-scroll-container::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }
        .horizontal-scroll-container p { /* Style for loading/error messages */
            padding-left: 10px;
        }
        .genre-chip {
            background-color: #333;
            color: #eee;
            padding: 10px 20px;
            border-radius: 20px;
            margin-right: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            font-size: 0.9em;
        }
        .genre-chip:hover {
            background-color: var(--accent-color-active);
        }
        .popular-item-card {
            flex: 0 0 140px; /* fixed width, don't grow, don't shrink */
            margin-right: 15px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .popular-item-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 8px;
            background-color: #2a2a2a; /* BG for while image loads */
        }
        .popular-item-card .item-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #genre-results-list {
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content no-hero">
            <!-- Universal Header: Search Bar and Tabs -->
            <div class="search-bar-container" id="search-bar-container">
                <input type="text" id="search-input" placeholder="Type to Search Anime...">
                <i class="fas fa-search" id="search-icon"></i>
            </div>
            <ul class="search-options-list" id="search-options-list">
                <li>
                    <button class="search-option-btn active" id="anime-option-btn" type="button">
                        <i class="fa-solid fa-tv"></i> Anime
                    </button>
                </li>
                <li>
                    <button class="search-option-btn" id="manga-option-btn" type="button">
                        <i class="fa-solid fa-book"></i> Manga
                    </button>
                </li>
                <li>
                    <button class="search-option-btn" id="browse-option-btn" type="button">
                        <i class="fa-solid fa-compass"></i> Browse
                    </button>
                </li>
            </ul>

            <!-- Search Content Area -->
            <section id="search-interaction-area">
                <div id="search-content-area">
                    <h2 class="section-title" id="results-title">Recents</h2>
                    <div class="item-list" id="search-item-list">
                        <!-- Recent searches or results will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Browse Content Area -->
            <section id="browse-interaction-area" style="display: none;">
                <!-- View for showing results of a specific genre -->
                <div id="genre-results-view" style="display: none;">
                    <button id="back-to-genres-btn" class="back-button">
                        <i class="fas fa-arrow-left"></i> Back to Genres
                    </button>
                    <h2 class="section-title" id="genre-results-title">Genre Results</h2>
                    <ul class="search-options-list" id="genre-results-tabs">
                        <li><button class="search-option-btn active" id="genre-anime-btn" type="button"><i class="fa-solid fa-tv"></i> Anime</button></li>
                        <li><button class="search-option-btn" id="genre-manga-btn" type="button"><i class="fa-solid fa-book"></i> Manga</button></li>
                    </ul>
                    <div class="item-list" id="genre-results-list"></div>
                </div>

                <!-- Main browse view with genre list and popular carousels -->
                <div id="main-browse-view">
                    <h2 class="section-title">Browse by Genre</h2>
                    <div class="horizontal-scroll-container" id="genre-list-container"></div>
                    <h2 class="section-title">Popular Anime</h2>
                    <div class="horizontal-scroll-container" id="popular-anime-list"></div>
                    <h2 class="section-title">Popular Manga</h2>
                    <div class="horizontal-scroll-container" id="popular-manga-list"></div>
                </div>
            </section>

            <!-- Iframe Container for Details Page -->
            <section id="iframe-container" style="display: none;">
                <button id="back-from-iframe-btn" class="back-button">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <iframe id="series-info-iframe" title="Series Information"></iframe>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selectors ---
            const searchInput = document.getElementById('search-input');
            const searchIcon = document.getElementById('search-icon');
            const searchItemList = document.getElementById('search-item-list');
            const resultsTitle = document.getElementById('results-title');
            const searchInteractionArea = document.getElementById('search-interaction-area');
            const iframeContainer = document.getElementById('iframe-container');
            const seriesInfoIframe = document.getElementById('series-info-iframe');
            const backFromIframeBtn = document.getElementById('back-from-iframe-btn');
            const searchBarContainer = document.getElementById('search-bar-container');

            // Main Tab Buttons
            const animeOptionBtn = document.getElementById('anime-option-btn');
            const mangaOptionBtn = document.getElementById('manga-option-btn');
            const browseOptionBtn = document.getElementById('browse-option-btn');

            // Browse View Elements
            const browseInteractionArea = document.getElementById('browse-interaction-area');
            const mainBrowseView = document.getElementById('main-browse-view');
            const genreListContainer = document.getElementById('genre-list-container');
            const popularAnimeList = document.getElementById('popular-anime-list');
            const popularMangaList = document.getElementById('popular-manga-list');

            // Genre Results View Elements
            const genreResultsView = document.getElementById('genre-results-view');
            const backToGenresBtn = document.getElementById('back-to-genres-btn');
            const genreResultsTitle = document.getElementById('genre-results-title');
            const genreResultsList = document.getElementById('genre-results-list');
            const genreAnimeBtn = document.getElementById('genre-anime-btn');
            const genreMangaBtn = document.getElementById('genre-manga-btn');

            // --- State Variables ---
            let searchMode = 'anime'; // 'anime' or 'manga'
            let currentView = 'search'; // 'search', 'browse', or 'iframe'
            let lastViewBeforeIframe = 'search';
            let currentGenre = { id: null, name: null };
            let allSearchResults = [];
            let currentSearchPage = 1;
            const resultsPerPage = 10;
            let searchTimeout;

            // --- View Management ---
            function switchView(view) {
                currentView = view;
                // Hide all main containers
                searchInteractionArea.style.display = 'none';
                browseInteractionArea.style.display = 'none';
                iframeContainer.style.display = 'none';

                // Manage search bar visibility
                searchBarContainer.style.display = (view === 'browse') ? 'none' : 'flex';

                // Deactivate all main tab buttons
                [animeOptionBtn, mangaOptionBtn, browseOptionBtn].forEach(btn => btn.classList.remove('active'));

                // Show the correct container and activate the correct tab
                if (view === 'search') {
                    searchInteractionArea.style.display = 'block';
                    (searchMode === 'anime' ? animeOptionBtn : mangaOptionBtn).classList.add('active');
                    if (!searchInput.value.trim()) displayRecentSearches();
                } else if (view === 'browse') {
                    browseInteractionArea.style.display = 'block';
                    browseOptionBtn.classList.add('active');
                    if (genreListContainer.innerHTML.trim() === '') {
                        loadBrowseContent();
                    }
                } else if (view === 'iframe') {
                    iframeContainer.style.display = 'flex';
                }
            }

            // --- API & Rendering Helper Functions ---
            const apiCall = async (url) => {
                const response = await fetch(url);
                if (!response.ok) {
                    let errorMsg = `Jikan API error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if(errorData && errorData.message) errorMsg += ` - ${errorData.message}`;
                    } catch (e) { /* ignore json parsing error */ }
                    throw new Error(errorMsg);
                }
                return response.json();
            };

            function createResultCard(item, type) {
                const listItem = document.createElement('div');
                listItem.className = 'list-item card-style';
                listItem.addEventListener('click', () => showSeriesInfo(item.mal_id, type));
                
                const thumbnail = `<div class="item-thumbnail"><img src="${item.images?.jpg?.image_url || 'https://placehold.co/60x80/444/fff?text=N/A'}" alt="${item.title}" loading="lazy"></div>`;
                
                const metaPills = [];
                if (item.score) metaPills.push(`<span class="meta-pill">${item.score}/10</span>`);
                if (type === 'anime' && item.episodes) metaPills.push(`<span class="meta-pill">${item.episodes} EP</span>`);
                if (type === 'manga' && item.chapters) metaPills.push(`<span class="meta-pill">${item.chapters} CH</span>`);
                
                const synopsis = item.synopsis ? (item.synopsis.length > 100 ? item.synopsis.substring(0, 100) + '...' : item.synopsis) : 'No description available.';
                
                const details = `
                    <div class="item-details">
                        <h3 class="item-title">${item.title_english || item.title}</h3>
                        <div class="item-meta">${metaPills.join('')}</div>
                        <p class="item-description">${synopsis}</p>
                    </div>`;
                
                const arrow = `<div class="item-arrow"><i class="fas fa-chevron-right"></i></div>`;

                listItem.innerHTML = thumbnail + details + arrow;
                return listItem;
            }

            // --- Iframe & Detail View Logic ---
            function showSeriesInfo(id, type) {
                lastViewBeforeIframe = currentView;
                seriesInfoIframe.src = `series-info.html?id=${id}${type === 'manga' ? '&manga=true' : ''}`;
                switchView('iframe');
            }

            function backFromIframe() {
                seriesInfoIframe.src = 'about:blank';
                switchView(lastViewBeforeIframe);
            }

            // --- Search Logic ---
            const getRecentSearches = () => JSON.parse(localStorage.getItem(`${searchMode}RecentSearches`) || '[]');
            const addRecentSearch = (term) => {
                if (!term) return;
                let searches = getRecentSearches().filter(s => s.toLowerCase() !== term.toLowerCase());
                searches.unshift(term);
                localStorage.setItem(`${searchMode}RecentSearches`, JSON.stringify(searches.slice(0, 5)));
            };
            const removeRecentSearch = (term) => {
                let searches = getRecentSearches().filter(s => s.toLowerCase() !== term.toLowerCase());
                localStorage.setItem(`${searchMode}RecentSearches`, JSON.stringify(searches));
                displayRecentSearches();
            };
            function displayRecentSearches() {
                searchItemList.innerHTML = '';
                searchItemList.className = 'item-list recent-searches-active';
                const searches = getRecentSearches();
                resultsTitle.textContent = 'Recents';
                if (searches.length === 0) {
                    searchItemList.innerHTML = '<p style="width: 100%; text-align: center;">No recent searches.</p>';
                    return;
                }
                searches.forEach(term => {
                    const recentItem = document.createElement('div');
                    recentItem.className = 'recent-search-item';
                    recentItem.innerHTML = `<span>${term}</span><i class="fas fa-times"></i>`;
                    recentItem.querySelector('span').addEventListener('click', () => {
                        searchInput.value = term;
                        performSearch(term);
                    });
                    recentItem.querySelector('i').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeRecentSearch(term);
                    });
                    searchItemList.appendChild(recentItem);
                });
            }
            async function performSearch(query) {
                if (!query) {
                    displayRecentSearches();
                    return;
                }
                resultsTitle.textContent = `Results for "${query}"`;
                searchItemList.innerHTML = '<p style="width: 100%; text-align: center;">Loading...</p>';
                searchItemList.className = 'item-list';
                try {
                    const data = await apiCall(`https://api.jikan.moe/v4/${searchMode}?q=${encodeURIComponent(query)}&limit=25`);
                    displaySearchResults(data.data, query);
                    if (data.data?.length > 0) addRecentSearch(query);
                } catch (error) {
                    console.error("Failed to fetch search results:", error);
                    searchItemList.innerHTML = `<p style="width: 100%; text-align: center; color: red;">Error: ${error.message}.</p>`;
                }
            }
            function displaySearchResults(data, query) {
                allSearchResults = data || [];
                searchItemList.innerHTML = '';
                if (allSearchResults.length === 0) {
                    searchItemList.innerHTML = `<p style="width: 100%; text-align: center;">No results found for "${query}".</p>`;
                    return;
                }
                allSearchResults.forEach(item => searchItemList.appendChild(createResultCard(item, searchMode)));
            }

            // --- Browse Logic ---
            function createPopularCard(item, type) {
                const card = document.createElement('div');
                card.className = 'popular-item-card';
                card.addEventListener('click', () => showSeriesInfo(item.mal_id, type));
                card.innerHTML = `
                    <img src="${item.images?.jpg?.large_image_url || 'https://placehold.co/140x200/444/fff?text=N/A'}" alt="${item.title}" loading="lazy">
                    <div class="item-title">${item.title}</div>`;
                return card;
            }
            async function loadBrowseContent() {
                genreListContainer.innerHTML = '<p>Loading genres...</p>';
                popularAnimeList.innerHTML = '<p>Loading...</p>';
                popularMangaList.innerHTML = '<p>Loading...</p>';

                try {
                    const [genresRes, popularAnimeRes, popularMangaRes] = await Promise.all([
                        apiCall('https://api.jikan.moe/v4/genres/anime'),
                        apiCall('https://api.jikan.moe/v4/top/anime?limit=15'),
                        apiCall('https://api.jikan.moe/v4/top/manga?limit=15')
                    ]);
                    
                    // Process Genres
                    genreListContainer.innerHTML = '';
                    genresRes.data.sort((a, b) => a.name.localeCompare(b.name)).forEach(genre => {
                        const chip = document.createElement('button');
                        chip.className = 'genre-chip';
                        chip.textContent = genre.name;
                        chip.addEventListener('click', () => showGenreResultsView(genre.mal_id, genre.name));
                        genreListContainer.appendChild(chip);
                    });

                    // Process Popular
                    popularAnimeList.innerHTML = '';
                    popularAnimeRes.data.forEach(item => popularAnimeList.appendChild(createPopularCard(item, 'anime')));
                    popularMangaList.innerHTML = '';
                    popularMangaRes.data.forEach(item => popularMangaList.appendChild(createPopularCard(item, 'manga')));
                } catch (error) {
                    console.error("Failed to load browse content:", error);
                    genreListContainer.innerHTML = `<p style="color:red;">Error loading genres.</p>`;
                    popularAnimeList.innerHTML = `<p style="color:red;">Error loading popular anime.</p>`;
                }
            }
            function showGenreResultsView(genreId, genreName) {
                currentGenre = { id: genreId, name: genreName };
                mainBrowseView.style.display = 'none';
                genreResultsView.style.display = 'block';
                genreResultsTitle.textContent = genreName;
                genreAnimeBtn.classList.add('active');
                genreMangaBtn.classList.remove('active');
                fetchAndDisplayGenreResults('anime');
            }
            function showMainBrowseView() {
                genreResultsView.style.display = 'none';
                mainBrowseView.style.display = 'block';
            }
            async function fetchAndDisplayGenreResults(type) {
                genreResultsList.innerHTML = '<p style="width: 100%; text-align: center;">Loading...</p>';
                try {
                    const data = await apiCall(`https://api.jikan.moe/v4/${type}?genres=${currentGenre.id}&limit=24`);
                    genreResultsList.innerHTML = '';
                    if (!data.data || data.data.length === 0) {
                        genreResultsList.innerHTML = `<p style="width: 100%; text-align: center;">No ${type} found for ${currentGenre.name}.</p>`;
                        return;
                    }
                    data.data.forEach(item => genreResultsList.appendChild(createResultCard(item, type)));
                } catch (error) {
                    console.error(`Failed to fetch ${type} for genre ${currentGenre.name}:`, error);
                    genreResultsList.innerHTML = `<p style="width: 100%; text-align: center; color: red;">Error loading results.</p>`;
                }
            }

            // --- Event Listeners ---
            [animeOptionBtn, mangaOptionBtn, browseOptionBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    const newMode = btn === browseOptionBtn ? 'browse' : 'search';
                    if (newMode === 'search') {
                        searchMode = (btn === animeOptionBtn) ? 'anime' : 'manga';
                        searchInput.placeholder = `Type to Search ${searchMode.charAt(0).toUpperCase() + searchMode.slice(1)}...`;
                        searchInput.value = '';
                    }
                    switchView(newMode);
                });
            });

            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(searchInput.value.trim()), 500);
            });
            searchInput.addEventListener('keypress', e => e.key === 'Enter' && (clearTimeout(searchTimeout), performSearch(searchInput.value.trim())));
            searchIcon.addEventListener('click', () => (clearTimeout(searchTimeout), performSearch(searchInput.value.trim())));
            
            backFromIframeBtn.addEventListener('click', backFromIframe);
            backToGenresBtn.addEventListener('click', showMainBrowseView);

            genreAnimeBtn.addEventListener('click', () => {
                if (genreAnimeBtn.classList.contains('active')) return;
                genreAnimeBtn.classList.add('active');
                genreMangaBtn.classList.remove('active');
                fetchAndDisplayGenreResults('anime');
            });
            genreMangaBtn.addEventListener('click', () => {
                if (genreMangaBtn.classList.contains('active')) return;
                genreMangaBtn.classList.add('active');
                genreAnimeBtn.classList.remove('active');
                fetchAndDisplayGenreResults('manga');
            });
            
            // --- Initial Load ---
            switchView('search');
        });
    </script>
</body>
</html>